//>>built
define("epi/shell/widget/ComponentController",["dojo/_base/array","dojo/_base/declare","dojo/_base/Deferred","dojo/_base/lang","dojo/aspect","dojo/has","dojo/promise/all","dojo/when","dojo/store/JsonRest","dojo/store/Memory","dijit/_WidgetBase","epi/dependency","epi/routes","require","epi/shell/ViewSettings","epi/shell/widget/WidgetFactory"],function(_1,_2,_3,_4,_5,_6,_7,_8,_9,_a,_b,_c,_d,_e,_f,_10){return _2([_b],{moduleArea:null,widgetFactory:null,_componentsMemoryStore:null,_componentsStore:null,_componentsSortOrderStore:null,_saveComponentRequestQueue:[],_isSaveComponentRequestInProgress:false,postMixInProperties:function(){var _11;this.inherited(arguments);this.widgetFactory=this.widgetFactory||_c.resolve("epi.shell.widget.WidgetFactory");_11=_c.resolve("epi.storeregistry");this._componentsStore=this._componentsStore||_11.get("epi.shell.component");this._componentsSortOrderStore=this._componentsSortOrderStore||_11.get("epi.shell.componentsortorder");this._componentsMemoryStore=new _a();this.own(_5.after(this.widgetFactory,"onWidgetCreated",_4.hitch(this,this.onComponentCreated),true));},onComponentCreated:function(_12,_13){var cd=_4.clone(_13);cd._widgetId=_12.get("id");this._componentsMemoryStore.put(cd);},_queryComponentDefinitions:function(_14){return this._componentsMemoryStore.query(_14);},_runSaveComponentRequest:function(_15){var _16=this,_17;if(_15||!this._isSaveComponentRequestInProgress){this._isSaveComponentRequestInProgress=true;_17=this._saveComponentRequestQueue.shift();if(_17){this._componentsStore.put(_17.item).then(function(_18){if(_17.promise!=null){_17.promise.resolve(_18);}_16._runSaveComponentRequest(true);},function(_19){if(_17.promise!=null){_17.promise.reject(_19);}_16._runSaveComponentRequest(true);});}else{this._isSaveComponentRequestInProgress=false;}}},getComponentDefinition:function(_1a){return this._queryComponentDefinitions({_widgetId:_1a})[0];},getComponentDefinitionById:function(id){return this._queryComponentDefinitions({id:id})[0];},getEmptyComponentDefinition:function(_1b,_1c){_8(this._componentsStore.query({componentTypeName:_1b}),_1c);},getComponentsForContainer:function(_1d){var _1e=this.getComponentDefinition(_1d.id).id;return this._componentsStore.query({viewName:_f.viewName,parentId:_1e});},getComponentsForView:function(_1f,_20){return this._componentsStore.query({viewName:_1f});},removeComponent:function(_21){var _22=this;return _8(this._componentsStore.remove(_21+"?viewName="+_f.viewName),function(){_22._componentsMemoryStore.remove(_21);});},saveComponent:function(_23){var _24=_4.clone(_23),_25=new _3();delete _24["components"];this._saveComponentRequestQueue.push({"item":_24,"promise":_25});this._runSaveComponentRequest(false);return _25.promise;},sortComponents:function(_26,_27,_28){var _29=this.getComponentDefinition(_26.id).id;_8(this._componentsSortOrderStore.put({id:_29,viewName:_f.viewName,components:_27}),_28);},addComponent:function(_2a,_2b,_2c,_2d){var _2e=this.getComponentDefinition(_2a.id).id;var _2f=_4.clone(_2b);delete _2f["id"];_2f.parentId=_2e;_2f.viewName=_f.viewName;var _30=this;_8(this._componentsStore.put(_2f),function(){if(_2f.settings["routeData"]){_2f.settings.routeData.gadgetId=_2f.id;}if(_2c){_8(_30.createComponents([_2f],_2a),function(def){if(def){if(typeof _2d=="function"){_2d(true,_2f);}}});}},function(){alert("Error: could not add component");if(typeof _2d=="function"){_2d(false,_2f);}});},loadComponents:function(_31){var _32=this,def=new _3();if(!(_31 instanceof Array)){_31=[_31];}_8(this.getComponentsForView(_f.viewName),function(_33){if(false){var _34=_e.timedGroup("ComponentController::loadComponents");}var _35=_32._convertListToHierarchyByMatchingParent(_33,"id","parentId","components");_8(_32.createComponents(_35,_31),function(_36){if(false){_34.end();}def.resolve(_36);},function(e){console.error(e.stack||e);def.reject(e);});},function(){def.reject();});return def;},_convertListToHierarchyByMatchingParent:function(_37,_38,_39,_3a){var map={};var _3b=[];_1.forEach(_37,function(_3c){var id=_3c[_38];map[id]=_3c;});_1.forEach(_37,function(_3d){var _3e;var id=_3d[_38];var _3f=_3d[_39];if(!(_3a in _3d)){_3d[_3a]=[];}_3e=map[_3f];if(!_3e||_3e==_3d){if(_1.indexOf(_3b,_3d)<0){_3b.push(_3d);}}else{if(!_3e[_3a]){_3e[_3a]=[];}_3e[_3a].push(_3d);}});return _3b;},createComponents:function(_40,_41){var _42=this.widgetFactory,_43=_40,_44,_45;if(_43 instanceof Array&&_43.length>0){if(_43[0] instanceof Array){var _46=[];for(var i=0;i<_43.length;i++){_44=_43[i];_46.push(_42.createWidgets(_41[i],_44));}return _7(_46);}else{_45=_41;if(_45 instanceof Array){_45=_45[0];}return _42.createWidgets(_45,_43);}}return [];}});});