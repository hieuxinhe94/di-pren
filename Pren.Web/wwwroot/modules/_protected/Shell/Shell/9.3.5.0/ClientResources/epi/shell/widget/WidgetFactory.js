//>>built
define("epi/shell/widget/WidgetFactory",["dojo/_base/array","dojo/_base/Deferred","dojo/_base/declare","dojo/_base/lang","dojo/_base/window","dojo/dom","dojo/promise/all","dojo/when","epi/string","epi/dependency","dijit/_Widget","dijit/_Container","dojox/layout/GridContainerLite","epi/shell/widget/ToolbarDropDownButton","epi/shell/widget/ToolbarSet"],function(_1,_2,_3,_4,_5,_6,_7,_8,_9,_a){return _3(null,{_domNodeName:"[domnode]",_handlers:null,moduleManager:null,messageService:undefined,onWidgetHierarchyCreated:null,onWidgetCreated:null,constructor:function(_b){_3.safeMixin(this,_b);this._handlers=[];this._addDefaultHandlers();this.messageService=this.messageService||_a.resolve("epi.shell.MessageService");this.moduleManager=this.moduleManager||_a.resolve("epi.ModuleManager");},createWidgets:function(_c,_d,_e){var _f,_10,_11=[],_12=[],_13=new _2(),_14;_e===false?_e=false:_e=true;if(typeof (_c)==="string"){_c=_6.byId(_c);}if(_d&&!_4.isArray(_d)){_d=[_d];}if(this.getHandler(_c).type===this._domNodeName){_f=_5.doc.createDocumentFragment();_f.tagName="documentFragment";}_10=_4.hitch(this,function(_15){if(_15 instanceof Array){for(var i in _15){_10(_15[i]);}}if(_15.components instanceof Array){_10(_15.components);}if(_15.moduleName){_12.push(this.moduleManager.startModules(_15.moduleName));}if(_15.widgetPackage){_11.push(_9.slashName(_15.widgetPackage));}else{if(_15.widgetType){_11.push(_9.slashName(_15.widgetType));}}});_10(_d);_14=require.on("error",function(_16){console.error(_16.stack||_16);_14.remove();_13.reject(_16);});_7(_12).then(_4.hitch(this,function(){require(_11,_4.hitch(this,function(){_14.remove();this._createWidgets(_f||_c,_d).then(function(_17){try{_f&&_c.appendChild(_f);if(_e){_1.forEach(_17,function(w){!w._started&&w.startup&&w.startup();});}_13.resolve(_17);}catch(err){_13.reject(err);}},_13.reject);}));}));return _13;},_createWidgets:function(_18,_19){var dfd=new _2(),_1a=[],_1b=this.getHandler(_18),_1c;if(!_1b||!_4.isArray(_19)){dfd.resolve(_1a);return dfd;}_1c=_1.map(_19,_4.hitch(this,function(_1d){var _1e=new _2(),_1f=this._createInternal(_18,_1d,_1b);_1f.then(function(_20){if(_20){_1a.push(_20);}_1e.resolve(_20);},function(e){console.error(e.stack||e);_1e.reject(e);});return _1e;}));_7(_1c).then(function(){dfd.resolve(_1a);},function(_21){console.error("WidgetFactory: Could not resolve one or more widgets");dfd.reject(_21);});return dfd;},_createInternal:function(_22,_23,_24){var _25=new _2();_8(_24.instantiateWidgetFunction(_23),_4.hitch(this,function(_26){if(_26){try{if(typeof this.onWidgetCreated=="function"){this.onWidgetCreated(_26,_23);}_24.addWidgetToRootFunction(_22,_26);}catch(e){_25.reject(e);return;}var _27=new _2();if(_23.components&&_4.isArray(_23.components)&&_23.components.length>0){_27=this._createWidgets(_26,_23.components);}else{_27.resolve();}_27.then(_4.hitch(this,function(){try{if(typeof this.onWidgetHierarchyCreated=="function"){this.onWidgetHierarchyCreated(_26,_23);}_25.resolve(_26);}catch(e){_25.reject(e);}}),_25.reject);}else{_25.reject();}}),function(_28){console.error(_28.stack||_28);_25.reject(_28);});return _25;},defaultWidgetInstantiator:function(_29){var def=new _2();var _2a=_4.mixin({},_29.settings,{componentId:_29.id});var _2b=_9.slashName(_29.widgetType);var _2c=_29.widgetPackage&&_4.getObject(_29.widgetType);var _2d=require.on("error",function(_2e){console.error(_2e.stack||_2e);_2d.remove();def.reject(_2e);});function _2f(_30){var _31=new _30(_2a);if(_29.connections){for(var evt in _29.connections){if(_29.connections[evt]){_31.connect(_31,evt,_29.connections[evt]);}}}_2d.remove();def.resolve(_31);};if(_2c){_2f(_2c);}else{require([_2b],_4.hitch(this,_2f));}return def;},_notifyError:function(msg){if(this.messageService){this.messageService.put("error",msg);}},_addDefaultHandlers:function(){this.addHandler(this._domNodeName,function(_32,_33){_33.placeAt(_32);},null,function(){return true;});this.addHandler("dijit/_Widget",function(_34,_35){_34.set("content",_35);});this.addHandler("dijit/_Container",function(_36,_37){_36.addChild(_37);});this.addHandler("dojox/layout/GridContainerLite",function(_38,_39){_38.addChild(_39,_39.params.column);});this.addHandler("epi/shell/widget/ToolbarDropDownButton",function(_3a,_3b){_3a.addChild(_3b);});this.addHandler("epi/shell/widget/ToolbarSet",function(_3c,_3d){_3c.addChild(_3d);});},addHandler:function(_3e,_3f,_40,_41){var _42=function(_43,_44){return _44&&_4.isFunction(_43.isInstanceOf)&&_43.isInstanceOf(_44);};var _45=_4.hitch(this,function(_46){var _47=this.getHandlerByTypeName(_3e);var _48=_41||_42;var _49=_47?true:false;if(!_49){_47={};}var _4a=_40||_4.hitch(this,this.defaultWidgetInstantiator);_47.type=_3e;_47.instantiateWidgetFunction=_4a;_47.addWidgetToRootFunction=_3f;_47.widgetConstructor=_46;_47.canHandle=_48;if(!_49){this._handlers.push(_47);}});if(_3e!=this._domNodeName){require([_9.slashName(_3e)],_45);}else{_45();}},getHandler:function(_4b){var _4c=this._handlers;for(var i=_4c.length-1;i>=0;i--){if(_4c[i].canHandle(_4b,_4c[i].widgetConstructor)){return _4c[i];}}return null;},getHandlerByTypeName:function(_4d){var _4e=this._handlers;for(var i=0;i<_4e.length;i++){if(_4e[i].type===_4d){return _4e[i];}}return null;},removeHandler:function(_4f){var _50=this._handlers;for(var i=0;i<_50.length;i++){if(_50[i].type===_4f){_50.splice(i,1);}}},listHandlers:function(){var _51=this._handlers;return _1.map(_51,function(_52){return _52.type;});}});});