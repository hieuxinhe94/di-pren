//>>built
define("epi/shell/store/Patchable",["dojo/_base/lang","dojo/Deferred","dojo/promise/all","dojo/store/Cache","dojo/store/Observable","dojo/when"],function(_1,_2,_3,_4,_5,_6){return function(_7,_8,_9){var _a=_4(_7,_8,_9||{}),_b=[];var _c=function(_d,_e){if(typeof _d!==typeof _e){console.error("The store was queried with a ["+typeof _d+"] but the entity id is a ["+typeof _e+"]");}};var _f=function(_10,_11){if(typeof _11=="object"){_10[_12.idProperty]=_11[_12.idProperty];}else{_10[_12.idProperty]=_11;}};var _13=function(_14){if(_14._cached){_14._cached=new Date();}else{Object.defineProperty(_14,"_cached",{value:new Date(),enumerable:false});}return _14;};var _15=function(_16){if(!_16._cached){return false;}var now=new Date();now.setMinutes(now.getMinutes()-5);return now>_16._cached;};_a.get=function(id,_17){return _6(_8.get(id),function(_18){if(_18){if(_15(_18)){_a.evict(id,_17);_18=null;}}return _18||_6(_7.get(id,_17),function(_19){if(_19){_c(id,_19[_7.idProperty]);_8.put(_13(_19),{id:id});}return _19;});});};_a.put=function(_1a,_1b){_8.remove((_1b&&_1b.id)||this.getIdentity(_1a));return _6(_7.put(_1a,_1b),function(_1c){_f(_1a,_1c);_8.put(typeof _1c=="object"?_13(_1c):_13(_1a),_1b);return _1c;});};_a.add=function(_1d,_1e){return _6(_7.add(_1d,_1e),function(_1f){_f(_1d,_1f);_8.add(typeof _1f=="object"?_13(_1f):_13(_1d),_1e);return _1f;});};var _20=function(obj){return obj&&_1.isObject(obj)&&!_1.isArray(obj)&&!_1.isFunction(obj);};var _21=function(_22,_23){var _24,s,_25={};for(_24 in _23){s=_23[_24];if(_24 in _22&&(_22[_24]!==s&&(!(_24 in _25)||_25[_24]!==s))){if(_20(s)&&_20(_22[_24])){_21(_22[_24],s);}else{_22[_24]=s;}}}return _22;};var _12=_1.delegate(_5(_a),{refresh:function(id){return _6(this.evict(id),_1.hitch(this,function(){return _6(this.get(id),_1.hitch(this,function(_26){if(_26){this.notify(_26,id);this.updateDependentStores(_26);this.onItemChanged(id,_26);}return _26;}));}));},removeRange:function(ids){var _27=this;var _28=ids.map(function(id){_27.evict(id);});var _29=_3(_28).then(function(){return _6(_27.executeMethod("DeleteRange","",ids));});_29.then(function(){ids.forEach(function(id){_27.notify(undefined,id);});});return _29;},patchCache:function(_2a){if(!_2a){return;}var id=this.getIdentity(_2a);return _6(this.get(id),_1.hitch(this,function(_2b){if(_2b){_2b=_21(_2b,_2a);_6(_8.put(_2b,{overwrite:true}),_1.hitch(this,function(){this.notify(_2b,id);this.updateDependentStores(_2a);this.onItemChanged(id,_2b);}));}return _2b;}));},addDependentStore:function(_2c,_2d){if(!_2c.patchCache){throw new Error("addDependentStore: The store must implement the patch method.");}_b.push({store:_2c,options:_2d||{}});},updateDependentStores:function(_2e){for(var i=_b.length-1;i>=0;i--){var _2f=_b[i].store;if(_b[i].options.refreshOnPatch){var _30=_b[i].options.refresh;if(typeof _30==="function"){_30(_2e);}else{_2f.refresh(this.getIdentity(_2e));}}else{var _31=_b[i].options.transformDelegate;_2f.patchCache(typeof _31==="function"?_31(_2e):_2e);}}},onItemChanged:function(id,_32){}});return _12;};});